name: Update Submodules

on:
  repository_dispatch:
    types: [update-submodules]

concurrency:
  group: update-submodules-${{ github.event.client_payload.type }}-${{ github.event.client_payload.name }}
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main repo (no submodules yet)
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.CSK_PAT }}
          submodules: false

      - name: Configure Git identity
        run: |
          git config user.name "ianhub-bot"
          git config user.email "bot@ianhub.net"
          git config --global url."https://${{ secrets.CSK_PAT }}@github.com/".insteadOf "https://github.com/"

      - name: Init first-level submodules
        run: |
          git submodule update --init --depth 1 -- projects/*

      - name: Recursively init nested submodules
        run: |
          git submodule foreach --recursive '
            echo "‚û°Ô∏è Updating $path"
            git submodule update --init --depth 1 || true
          '

      - name: Set up Bash (ensure shell with coreutils)
        shell: bash
        run: echo "Shell ready with core utilities"

      - name: Configure Git identity
        shell: bash
        run: |
          git config user.name "ianhub-bot"
          git config user.email "bot@ianhub.net"

      - name: Debug submodules
        run: |
          echo "=== .gitmodules ==="
          cat .gitmodules || echo "No .gitmodules"
          echo "=== Submodule status ==="
          git submodule status --recursive || true

      - name: Add or Update Submodule
        shell: bash
        run: |
          REPO="${{ github.event.client_payload.repo }}"
          NAME="${{ github.event.client_payload.name }}"
          SUB_PATH="projects/$DIR_NAME"

          echo "üì¶ Name: $NAME"
          echo "üîó Repo: $REPO"
          echo "üìÇ Submodule path: $SUB_PATH"

          if [ -d "$SUB_PATH" ]; then
            echo "‚úÖ Submodule exists. Updating..."
            git submodule update --remote "$SUB_PATH"
          else
            echo "‚ûï Submodule doesn't exist. Adding it..."
            mkdir -p "$(dirname "$SUB_PATH")"
            git submodule add "https://${{ secrets.CSK_PAT }}@github.com/$REPO" "$SUB_PATH"

            # Cleanup the URL from .gitmodules
            git config -f .gitmodules submodule."$SUB_PATH".url "https://github.com/$REPO"
            sed -i "s|https://.*@github.com/|https://github.com/|g" .gitmodules
            git submodule sync
          fi

          git add "$SUB_PATH"

          # Always add submodule path and .gitmodules in case it was added/changed
          git add .gitmodules "$SUB_PATH"

          # Fetch latest remote and merge only if nothing staged
          git fetch origin main

          if git diff --cached --quiet; then
            echo "üü¢ No staged changes. Safe to pull..."
            git merge --ff-only origin/main
          else
            echo "‚ö†Ô∏è Skipping merge to avoid overwriting staged submodule updates."
          fi

          if git diff --cached --quiet; then
            echo "üü° No changes to commit."
          else
            echo "üìù Committing changes..."
            git commit -m "Auto-update/add submodule: ${NAME:-unknown}"
          fi

          echo "üöÄ Pushing to origin (with retry)..."
          for i in 1 2 3; do
            git push && break || {
              echo "‚ùå Push failed. Retry #$i in 3s..."
              sleep 3
            }
          done

          git status -sb

          echo "‚úÖ Done."
